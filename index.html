<!doctype html>
<html>
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, user-scalable=no" />
  <meta name="apple-mobile-web-app-capable" content="yes" />
  <title>迷路</title>
  <script src="https://cdn.jsdelivr.net/npm/phina.js@0.2.3/build/phina.min.js"></script>
</head>
<body>
<script>

phina.globalize();

// 0=床, 1=壁, 2=ゴール, 3=上, 4=下, 5=右, 6=左, 7=ワープ

const MAP_DATA1 = [
  [1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1],
  [1,0,1,4,0,0,0,0,4,1,7,0,1,7,0,1],
  [1,0,1,1,1,1,1,0,1,1,0,0,1,1,1,1],
  [1,0,0,0,0,0,0,0,1,1,5,0,1,4,0,1],
  [1,0,1,7,1,1,1,7,1,1,1,1,1,1,1,1],
  [1,0,1,0,0,0,1,0,0,0,0,0,0,0,3,1],
  [1,0,1,0,0,0,1,1,1,1,1,1,1,1,1,1],
  [1,0,1,5,0,0,1,0,0,1,0,3,1,0,7,1],
  [1,0,1,1,1,0,1,0,7,1,0,6,1,0,6,1],
  [1,0,0,7,1,0,1,1,1,1,0,0,1,0,0,1],
  [1,0,0,5,1,6,1,0,0,0,0,7,1,0,2,1],
  [1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1],
];
const DOT_SIZE = 80;
var U = 0;

const ASSETS = {
  image: {
    player: 'items/player.png',
    floor: 'items/floor.png',
    wall: 'items/block.png',
    flag: 'items/flag.png',
    Uwall: 'items/Ublock.png',
    Ufloor: 'items/Ufloor.png',
    Uflag: 'items/Uflag.png',
    ue: 'items/jump.png',
    sita: 'items/jump.png',
    migi: 'items/jump.png',
    hidari: 'items/jump.png',
    waapu: 'items/waapu.png',
  },
  sound: {
    se: 'items/in the U.mp3',
  },
};

phina.define('MainScene1', {
  superClass: 'DisplayScene',
  init: function() {
    this.superInit({
      width: MAP_DATA1[0].length * DOT_SIZE,
      height: MAP_DATA1.length * DOT_SIZE,
    });

    for (let y = 0; y < MAP_DATA1.length; y++) {
      for (let x = 0; x < MAP_DATA1[y].length; x++) {
        let type = MAP_DATA1[y][x];
        let sprite;
        if (type === 1) {
          sprite = Sprite('wall').addChildTo(this);
        }
        else if (type === 2) {
          sprite = Sprite('flag').addChildTo(this);
        } 
        else if (type === 3) {
          sprite = Sprite('ue').addChildTo(this);
        }
        else if (type === 4) {
          sprite = Sprite('sita').addChildTo(this);
          sprite.rotation = 180;
        }
        else if (type === 5) {
          sprite = Sprite('migi').addChildTo(this);
          sprite.rotation = 90;
        }
        else if (type === 6) {
          sprite = Sprite('hidari').addChildTo(this);
          sprite.rotation = 270;
        }
        else if (type === 7){
          sprite = Sprite('waapu').addChildTo(this);
        } 
        else {
          sprite = Sprite('floor').addChildTo(this);
        }
        sprite.setSize(DOT_SIZE, DOT_SIZE);
        sprite.setPosition(x * DOT_SIZE + DOT_SIZE/2, y * DOT_SIZE + DOT_SIZE/2);
      }
    }

    this.playerX = 1;
    this.playerY = 1;
    this.player = Sprite('player')
      .setSize(DOT_SIZE, DOT_SIZE)
      .addChildTo(this);
    this.updatePlayerPos();

    this.isClear = false;
  },

  updatePlayerPos: function() {
    this.player.setPosition(this.playerX * DOT_SIZE + DOT_SIZE/2, this.playerY * DOT_SIZE + DOT_SIZE/2);
  },

  update: function(app) {
    if (this.isClear) return;

    let kb = app.keyboard;

    let nextX = this.playerX;
    let nextY = this.playerY;

    if (kb.getKeyDown('left'))  nextX--;
    if (kb.getKeyDown('right')) nextX++;
    if (kb.getKeyDown('up'))    nextY--;
    if (kb.getKeyDown('down'))  nextY++;

    if (MAP_DATA1[nextY] && MAP_DATA1[nextY][nextX] !== undefined) {
      let cell = MAP_DATA1[nextY][nextX];
      if (cell === 0) {
        this.playerX = nextX;
        this.playerY = nextY;
      } 
      else if (cell === 2) {
        this.playerX = nextX;
        this.playerY = nextY;
        this.gameClear();
      } 
      else if (cell === 3){
        this.playerX = nextX;
        this.playerY = nextY  - 4;
        U++;
      } 
      else if (cell === 4){
        this.playerX = nextX;
        this.playerY = nextY + 4;
        U++;
      }
      else if (cell === 5){
        this.playerX = nextX + 4;
        this.playerY = nextY;
        U++;
      }
      else if (cell === 6){
        this.playerX = nextX - 4;
        this.playerY = nextY;
        U++;
      } 
      else if (cell === 7){
        if(U === 6){
          U = 0;
          this.exit('main2');
        } else {
          this.playerX = 1;
          this.playerY = 1;
          U = 0;
        }
      }
    }

    this.updatePlayerPos();
  },

  gameClear: function() {
    this.isClear = true;
    this.exit('result');
  }
});

// 0=床, 1=壁, 2=ゴール, 3=上, 4=下, 5=右, 6=左, 7=ワープ
const MAP_DATA2 = [
  [1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1],
  [1,0,0,4,1,0,0,0,0,0,0,0,0,0,5,1,0,0,0,0,4,1],
  [1,0,0,0,1,6,0,0,0,0,0,0,7,1,1,1,1,1,1,1,1,1],
  [1,1,1,1,1,1,1,1,1,1,1,1,1,1,5,1,0,0,1,0,0,1],
  [1,7,0,0,0,0,0,3,1,0,3,1,0,0,4,1,0,0,1,0,0,1],
  [1,0,0,0,0,0,0,5,1,0,0,1,1,1,1,1,0,4,1,7,0,1],
  [1,4,0,4,0,0,0,4,1,0,5,1,0,0,7,1,0,7,1,1,1,1],
  [1,1,1,1,1,1,1,1,1,1,1,1,3,0,0,1,1,1,1,1,1,1],
  [1,7,1,7,1,3,0,0,0,0,1,1,1,1,1,1,1,0,0,1,3,1],
  [1,0,1,0,1,0,0,0,0,7,1,1,5,1,7,0,1,5,0,1,0,1],
  [1,0,1,0,1,1,1,1,1,1,1,1,0,1,0,0,1,6,0,1,4,1],
  [1,4,1,5,1,0,0,0,0,0,7,1,0,1,0,0,1,1,1,1,1,1],
  [1,1,1,1,1,1,1,1,1,1,1,1,1,1,0,0,1,6,0,1,0,1],
  [1,0,0,0,0,0,7,1,0,0,0,0,0,1,0,0,1,0,0,1,0,1],
  [1,0,0,0,0,0,5,1,7,0,0,0,3,1,0,5,1,0,0,1,2,1],
  [1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1],
];

const DOT_SIZE2 = 60;

phina.define('MainScene2', {
  superClass: 'DisplayScene',

  init: function() {
    this.superInit({

      width: MAP_DATA2[0].length * DOT_SIZE2,
      height: MAP_DATA2.length * DOT_SIZE2,
  });

    SoundManager.setVolume(0.5);
    SoundManager.playMusic('se');

    for (let y = 0; y < MAP_DATA2.length; y++) {
      for (let x = 0; x < MAP_DATA2[y].length; x++) {
        let type = MAP_DATA2[y][x];
        let sprite;
        if (type === 1) {
          sprite = Sprite('Uwall').addChildTo(this);
        }
        else if (type === 2) {
          sprite = Sprite('Uflag').addChildTo(this);
        } 
        else if (type === 3) {
          sprite = Sprite('ue').addChildTo(this);
        }
        else if (type === 4) {
          sprite = Sprite('sita').addChildTo(this);
          sprite.rotation = 180;
        }
        else if (type === 5) {
          sprite = Sprite('migi').addChildTo(this);
          sprite.rotation = 90;
        }
        else if (type === 6) {
          sprite = Sprite('hidari').addChildTo(this);
          sprite.rotation = 270;
        }
        else if (type === 7){
          sprite = Sprite('waapu').addChildTo(this);
        } 
        else {
          sprite = Sprite('Ufloor').addChildTo(this);
        }

        sprite.setSize(DOT_SIZE2, DOT_SIZE2);
        sprite.setPosition(x * DOT_SIZE2 + DOT_SIZE2/2, y * DOT_SIZE2 + DOT_SIZE2/2);
      }
    }

    this.playerX = 1;
    this.playerY = 1;

    this.player = Sprite('player')
      .setSize(DOT_SIZE2, DOT_SIZE2)
      .addChildTo(this);
    this.updatePlayerPos();

    this.isClear = false;
  },

  updatePlayerPos: function() {
    this.player.setPosition(this.playerX * DOT_SIZE2 + DOT_SIZE2/2, this.playerY * DOT_SIZE2 + DOT_SIZE2/2);
  },

  update: function(app) {
    if (this.isClear) return;

    let kb = app.keyboard;

    let nextX = this.playerX;
    let nextY = this.playerY;

    if (kb.getKeyDown('left'))  nextX--;
    if (kb.getKeyDown('right')) nextX++;
    if (kb.getKeyDown('up'))    nextY--;
    if (kb.getKeyDown('down'))  nextY++;

    if (MAP_DATA2[nextY] && MAP_DATA2[nextY][nextX] !== undefined) {
      let cell = MAP_DATA2[nextY][nextX];
      if (cell === 0) {
        this.playerX = nextX;
        this.playerY = nextY;
      } 
      else if (cell === 2) {
        this.playerX = nextX;
        this.playerY = nextY;
        this.gameClear();
      } 
      else if (cell === 3){
        this.playerX = nextX;
        this.playerY = nextY  - 3;
        U++;
      } 
      else if (cell === 4){
        this.playerX = nextX;
        this.playerY = nextY + 3;
        U++;
      }
      else if (cell === 5){
        this.playerX = nextX + 3;
        this.playerY = nextY;
        U++;
      }
      else if (cell === 6){
        this.playerX = nextX - 3;
        this.playerY = nextY;
        U++;
      } 
      else if (cell === 7){
          this.playerX = 1;
          this.playerY = 1;
      }
    }

    this.updatePlayerPos();
  },

  gameClear: function() {
    this.isClear = true;
    this.exit('result2');
  }
});

// リザルトシーン
phina.define('ResultScene1', {
  superClass: 'DisplayScene',
  init: function() {
    this.superInit({
      width: 1280,
      height: 960,
    });

    this.backgroundColor = "#00bfff";

    Label({
      text: 'おめでとう！クリア！！',
      fill: 'white',
      fontSize: 60,
    }).addChildTo(this).setPosition(this.width/2, this.height/3);

    let button = Button({
      text: "もう一回",
      fill: "#ff6f61",
      fontSize: 32,
      width: 200,
      height: 80,
    }).addChildTo(this).setPosition(this.width/2, this.height*2/3);

    button.onpush = () => {
      this.exit('main');
    };
  }
});

//裏リザルト
phina.define('ResultScene2', {
  superClass: 'DisplayScene',
  init: function() {
    this.superInit({
      width: 1280,
      height: 960,
    });

    let grad = Canvas.createLinearGradient(0, 0, 0, this.height);
    grad.addColorStop(0, "#000000");
    grad.addColorStop(1, "#333333");
    this.backgroundColor = grad;

    Label({
      text: 'C L E A R',
      fill: 'red',
      stroke: 'red',
      strokeWidth: 4,
      fontSize: 70,
    }).addChildTo(this).setPosition(this.width/2, this.height/2);
  }
});

phina.main(function() {
  var app = GameApp({
    startLabel: 'main',
    assets: ASSETS,
    width: 1300,
    height: 1000,
    scenes: [
      {label: 'main', className: 'MainScene1'},
      {label: 'main2', className: 'MainScene2'},
      {label: 'result', className: 'ResultScene1'},
      {label: 'result2', className: 'ResultScene2'},
    ]
  });
  app.run();
});

</script>
</body>
</html>
